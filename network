#!/bin/bash

. /etc/rc.conf
. /etc/rc.d/functions

ifup()
{
  varname="\$${1}"
  eval new_ifline=$varname
  if [ "$new_ifline" = "dhcp" ]; then
    # remove the .pid file if it exists
    rm -f /etc/dhcpc/dhcpcd-${1}.{pid,cache} >/dev/null 2>&1
    /usr/sbin/dhcpcd -t 10 -h $HOSTNAME $1
  else
    /sbin/ifconfig $new_ifline
  fi
  return $?
}

ifdown()
{
  varname="\$${1}"
  eval new_ifline=$varname
  if [ "$new_ifline" = "dhcp" ]; then
    /bin/kill `cat /etc/dhcpc/dhcpcd-${1}.pid`
  else
    /sbin/ifconfig $new_ifline down
  fi
  return $?
}

rtup()
{
  varname="\$${1}"
  eval new_rtline=$varname
  /sbin/route add $new_rtline
  return $?
}

rtdown()
{
  varname="\$${1}"
  eval new_rtline=$varname
  /sbin/route del $new_rtline
  return $?
}

case "$1" in
  start)
    if ! ck_daemon network; then
      echo "Network is already running.  Try 'network restart'"
      exit
    fi
    stat_busy "Starting Network"
    error=0
    for ifline in ${INTERFACES[@]}; do
      if echo $ifline | grep '^[^\!]' >/dev/null 2>&1; then
        ifup $ifline || error=1
      fi
    done
    for rtline in "${ROUTES[@]}"; do
      if echo $rtline | grep '^[^\!]' 2>&1 >/dev/null; then
        rtup $rtline || error=1
      fi
    done
    if [ $error -eq 0 ]; then
      add_daemon network
      stat_done
    else
      stat_fail
    fi
    ;;
  stop)
    if ck_daemon network; then
      echo "Network is not running.  Try 'network start'"
      exit
    fi
    stat_busy "Stopping Network"
    rm_daemon network
    error=0
    for rtline in "${ROUTES[@]}"; do
      if echo $rtline | grep '^[^\!]' 2>&1 >/dev/null; then
        rtdown $rtline || error=1
      fi
    done
    for ifline in ${INTERFACES[@]}; do
      if echo $ifline | grep '^[^\!]' 2>&1 >/dev/null; then
        ifdown $ifline || error=1
      fi
    done
    if [ $error -eq 0 ]; then
      stat_done
    else
      stat_fail
    fi
    ;;
  restart)
    $0 stop
    sleep 2
    $0 start
    ;;
  *)
    echo "usage: $0 {start|stop|restart}"  
esac
